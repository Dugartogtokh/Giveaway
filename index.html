<!DOCTYPE html>
<html lang="mn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—É–≥–∞–ª–∞–∞–Ω—ã –ê–∑—Ç–∞–Ω –®–∞–ª–≥–∞—Ä—É—É–ª–∞—Ö</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;500;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            min-height: 100vh;
            overflow: hidden;
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .winner-anim {
            animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }

        /* iOS Picker Style */
        .picker-mask {
            background: linear-gradient(to bottom, 
                rgba(255,255,255,1) 0%, 
                rgba(255,255,255,0.8) 15%, 
                rgba(255,255,255,0) 40%, 
                rgba(255,255,255,0) 60%, 
                rgba(255,255,255,0.8) 85%, 
                rgba(255,255,255,1) 100%
            );
            pointer-events: none;
        }
        .wheel-item {
            height: 60px; /* ”®–Ω–¥”©—Ä */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #374151;
            font-size: 1.1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 20px;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4 h-screen w-screen">

    <audio id="drumSound" src="https://www.soundjay.com/misc/sounds/drum-roll-01.mp3" loop></audio>
    <audio id="winSound" src="https://www.soundjay.com/misc/sounds/ta-da-01.mp3"></audio>

    <div class="glass w-full max-w-7xl p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 h-[95vh] overflow-hidden">
        
        <div class="lg:col-span-3 flex flex-col h-full border-r pr-4 border-gray-200 space-y-3 overflow-hidden">
            <h1 class="text-lg font-bold text-gray-800 border-b pb-2 flex-shrink-0">üìù –û—Ä–æ–ª—Ü–æ–≥—á–∏–¥</h1>
            
            <div class="flex-shrink-0 space-y-3">
                <label class="cursor-pointer bg-blue-50 text-blue-800 py-2 px-3 rounded text-center text-xs font-bold border border-blue-200 hover:bg-blue-100 transition block">
                    üìÇ Excel —Ñ–∞–π–ª –Ω—ç—ç—Ö
                    <input type="file" id="excelFile" accept=".xlsx, .xls" class="hidden" onchange="handleFileUpload(this)">
                </label>

                <div class="space-y-2">
                    <input type="text" id="lastName" placeholder="–û–≤–æ–≥" class="w-full p-2 text-xs rounded border focus:ring-2 ring-blue-400 outline-none">
                    <input type="text" id="firstName" placeholder="–ù—ç—Ä" class="w-full p-2 text-xs rounded border focus:ring-2 ring-blue-400 outline-none">
                    <button onclick="addParticipant()" class="w-full bg-blue-600 text-white py-1 rounded text-sm hover:bg-blue-700 font-bold">+</button>
                </div>

                <div class="flex justify-between items-center mt-2 bg-gray-100 p-2 rounded">
                    <span class="text-xs text-gray-500">–ë–æ–ª–æ–º–∂–∏—Ç –∞–∑—Ç–∞–Ω:</span>
                    <b id="count" class="text-lg text-blue-600">0</b>
                </div>
                <button onclick="clearList()" class="text-xs text-red-400 hover:text-red-600 underline w-full text-right">–ñ–∞–≥—Å–∞–∞–ª—Ç —Ü—ç–≤—ç—Ä–ª—ç—Ö</button>
            </div>
            
            <div class="flex-grow overflow-y-auto bg-white rounded border border-gray-200 relative">
                <ul id="participantList" class="divide-y divide-gray-100 absolute w-full top-0 left-0"></ul>
            </div>
        </div>

        <div class="lg:col-span-5 flex flex-col items-center justify-center h-full relative py-2 overflow-hidden">
            
            <div class="text-center mb-6 w-full flex-shrink-0">
                <span id="prizeTag" class="bg-indigo-100 text-indigo-800 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide mb-2 inline-block">
                    –≠—ç–ª–∂–∏—Ç —à–∞–≥–Ω–∞–ª
                </span>
                <div class="relative w-full h-48 mb-2 flex items-center justify-center">
                    <img id="prizeImage" src="" alt="Prize" class="max-h-full max-w-full object-contain drop-shadow-xl transition-all duration-500 transform">
                </div>
                <h2 id="prizeName" class="text-xl font-bold text-gray-800 truncate px-2">...</h2>
                <p id="prizeCounter" class="text-sm text-gray-500 font-medium">“Æ–ª–¥—ç–≥–¥—ç–ª: -</p>
            </div>

            <div class="relative w-full h-48 bg-white rounded-xl border-2 border-indigo-200 shadow-inner mb-6 overflow-hidden select-none">
                
                <div id="wheelTrack" class="absolute w-full text-center z-0 will-change-transform" style="padding-top: 66px; transform: translateY(0px);">
                    <div class="wheel-item text-gray-400 font-normal">???</div>
                </div>

                <div class="absolute top-[66px] w-full h-[60px] border-y-2 border-indigo-400/30 z-10 pointer-events-none"></div>
                
                <div class="absolute inset-0 z-20 picker-mask"></div>

                <div id="finalResultOverlay" class="hidden absolute inset-0 z-30 flex items-center justify-center bg-white/90 backdrop-blur-sm transition-opacity duration-500">
                    <h1 id="finalWinnerText" class="text-3xl font-extrabold text-indigo-700 winner-anim px-4 text-center"></h1>
                </div>
            </div>

            <button onclick="startLottery()" id="startBtn" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:scale-105 transition transform text-lg flex-shrink-0">
                –≠—Ö–ª“Ø“Ø–ª—ç—Ö
            </button>
        </div>

        <div class="lg:col-span-4 flex flex-col h-full border-l pl-4 border-gray-200 bg-gray-50 -mr-6 pr-6 py-4 rounded-r-xl overflow-hidden">
            <h3 class="text-md font-bold text-gray-700 uppercase mb-4 flex items-center gap-2 flex-shrink-0">
                üèÜ –ê–∑—Ç–∞–Ω—É—É–¥—ã–Ω —Å–∞–º–±–∞—Ä
            </h3>
            <div class="flex-grow overflow-y-auto rounded-lg border border-gray-200 bg-white shadow-sm relative">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100 sticky top-0 z-10">
                        <tr>
                            <th class="px-4 py-3 w-10">#</th>
                            <th class="px-4 py-3">–®–∞–≥–Ω–∞–ª</th>
                            <th class="px-4 py-3">–ê–∑—Ç–∞–Ω</th>
                        </tr>
                    </thead>
                    <tbody id="winnersTableBody" class="divide-y divide-gray-200"></tbody>
                </table>
                <div id="emptyState" class="text-center py-10 text-gray-400 text-xs italic absolute w-full top-10">–û–¥–æ–æ–≥–æ–æ—Ä –∞–∑—Ç–∞–Ω —Ç–æ–¥—Ä–æ–æ–≥“Ø–π –±–∞–π–Ω–∞.</div>
            </div>
        </div>
    </div>

    <script>
        const drumSound = document.getElementById('drumSound');
        const winSound = document.getElementById('winSound');

        const prizesConfig = [
            { id: 'nura', name: "Nura - –≠—Ä—Ö–∏–π–Ω –±–∏—á–∏–≥", total: 3, current: 0, img: "./prize/Nura.png" },
            { id: 'pcmall', name: "PC Mall - 1 —Å–∞—è ‚ÇÆ", total: 2, current: 0, img: "./prize/GIFTCARD-100.png" },
            { id: 'iphone', name: "iPhone 17", total: 2, current: 0, img: "./prize/iphone17.png" },
            { id: 'travel', name: "–ê—è–ª–ª—ã–Ω —ç—Ä—Ö (Super)", total: 1, current: 0, img: "./prize/Travel-Choice-Gift-Card-GC-UK_Online.jpeg" }
        ];

        let currentPrizeIndex = 0;
        let participants = [];
        let winnersCount = 0;
        let isSpinning = false;
        let lastVisibleName = "???";

        updateList();
        updatePrizeUI();

        // --- EXCEL ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    let added = 0;
                    jsonData.forEach((row) => {
                        let ovog = row['Ovog'] || row['ovog'] || row['Lastname'] || row['–û–≤–æ–≥'] || '';
                        let ner = row['Ner'] || row['ner'] || row['Firstname'] || row['–ù—ç—Ä'] || '';
                        if (!ner) {
                            Object.keys(row).forEach(k => {
                                const ck = k.trim().toLowerCase();
                                if(['ner','firstname','–Ω—ç—Ä'].includes(ck)) ner = row[k];
                                if(['ovog','lastname','–æ–≤–æ–≥'].includes(ck)) ovog = row[k];
                            });
                        }
                        if (ner) {
                            participants.push({ ovog: String(ovog).trim(), ner: String(ner).trim() });
                            added++;
                        }
                    });
                    alert(`${added} —Ö“Ø–Ω –Ω—ç–º—ç–≥–¥–ª—ç—ç.`);
                    updateList();
                } catch (err) { alert("–§–∞–π–ª —É–Ω—à–∏—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞."); }
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // --- IMPROVED WHEEL LOGIC (FIXED STOP POINT) ---
        
        function startLottery() {
            if (participants.length === 0) {
                alert("–û—Ä–æ–ª—Ü–æ–≥—á –±–∞–π—Ö–≥“Ø–π –±–∞–π–Ω–∞!");
                return;
            }
            if (isSpinning) return;
            isSpinning = true;

            try {
                drumSound.currentTime = 0;
                drumSound.volume = 1.0;
                drumSound.play();
            } catch (e) {}

            const btn = document.getElementById('startBtn');
            btn.disabled = true;
            btn.innerText = "ü•Å ...";
            btn.classList.add('opacity-75', 'cursor-not-allowed');
            
            document.getElementById('finalResultOverlay').classList.add('hidden');

            // 1. –Ø–ª–∞–≥—á–∏–π–≥ —Å–æ–Ω–≥–æ—Ö
            const winnerIndex = Math.floor(Math.random() * participants.length);
            const winner = participants[winnerIndex];

            // 2. Animation –±—ç–ª—Ç–≥—ç–ª
            const track = document.getElementById('wheelTrack');
            const ITEM_HEIGHT = 60;
            const SPINS_COUNT = 100; // Increased random spins 
            
            // 3. HTML String —É–≥—Å—Ä–∞—Ö
            let html = '';
            
            // A. –≠–•–ù–ò–ô ITEM: –û–¥–æ–æ —Ö–∞—Ä–∞–≥–¥–∞–∂ –±–∞–π–≥–∞–∞ –Ω—ç—Ä–∏–π–≥ —ç—Ö—ç–Ω–¥ –Ω—å —Ç–∞–≤–∏–Ω–∞
            html += `<div class="wheel-item text-gray-500">${lastVisibleName}</div>`;
            
            // B. –î–£–ù–î–´–ù ITEMS: –°–∞–Ω–∞–º—Å–∞—Ä–≥“Ø–π –Ω—ç—Ä—Å
            for (let i = 0; i < SPINS_COUNT; i++) {
                const r = participants[Math.floor(Math.random() * participants.length)];
                html += `<div class="wheel-item opacity-60">${r.ovog} ${r.ner}</div>`;
            }

            // C. –¢”®–ì–°–ì”®–õ–ò–ô–ù ITEM: –Ø–ª–∞–≥—á
            html += `<div class="wheel-item font-bold text-indigo-800 scale-110">${winner.ovog} ${winner.ner}</div>`;
            
            // D. BUFFER ITEMS: –Ø–ª–∞–≥—á–∏–π–Ω –¥–∞—Ä–∞–∞ —Ö–∞—Ä–∞–≥–¥–∞—Ö –Ω—ç—Ä–∏–π–≥ –±–∞–≥—Ç–∞–∞—Ö—ã–Ω —Ç—É–ª–¥ –Ω—ç–º–Ω—ç
            // –≠–Ω–¥ –Ω—ç–≥ –∂–∏–Ω—Ö—ç–Ω—ç –æ—Ä–æ–ª—Ü–æ–≥—á–∏–π–Ω –Ω—ç—Ä–∏–π–≥ –Ω—ç–º–∂ —Ö–∞—Ä—É—É–ª—ä—è (—Ç—É—Å–≥–∞–π–ª–∞–Ω —Å–æ–Ω–≥–æ—Ö —à–∞–∞—Ä–¥–ª–∞–≥–∞–≥“Ø–π, random –±–∞–π–∂ –±–æ–ª–Ω–æ)
            const nextP = participants[Math.floor(Math.random() * participants.length)];
            html += `<div class="wheel-item text-sm">${nextP.ovog} ${nextP.ner}</div>`;
            html += `<div class="wheel-item"></div><div class="wheel-item"></div>`; // 2 —Ö–æ–æ—Å–æ–Ω –∑–∞–π

            // 4. DOM —à–∏–Ω—ç—á–ª—ç—Ö
            track.style.transition = 'none';
            track.style.transform = 'translateY(0px)';
            track.innerHTML = html;

            void track.offsetHeight; // FORCE REFLOW

            // 5. START ANIMATION
            const duration = 6000; // 6 sec
            
            // 1 (LastVisible) + 100 (Randoms) = 101 items before the winner
            const ITEMS_BEFORE_WINNER = SPINS_COUNT + 1; 
            const targetY = ITEMS_BEFORE_WINNER * ITEM_HEIGHT; // 6060px

            // VISUAL CORRECTION: 5px-—ç—ç—Ä –¥–æ–æ—à–ª—É—É–ª–∞—Ö –Ω—å –¥–∞—Ä–∞–∞—Ö –Ω—ç—Ä–∏–π–≥ —Ç–∞—Å—Ä–∞–ª—Ç–≥“Ø–π —Ö–∞—Ä–∞–≥–¥—É—É–ª–Ω–∞
            const visualCorrection = 5; 

            track.style.transition = `transform ${duration}ms cubic-bezier(0.2, 0.8, 0.2, 1)`; 
            // - (targetY - visualCorrection) - negative transform moves the content UP
            // By decreasing targetY, we are moving the list UP by LESS, which effectively pushes the content DOWN slightly.
            track.style.transform = `translateY(-${targetY - visualCorrection}px)`;

            lastVisibleName = `${winner.ovog} ${winner.ner}`;

            // 6. FINISH
            setTimeout(() => {
                handleWin(winner);
            }, duration);
        }

        function handleWin(winner) {
            try {
                drumSound.pause();
                winSound.currentTime = 0;
                winSound.play();
            } catch (e) {}

            // –•–∞—Å–∞—Ö –ª–æ–≥–∏–∫
            const foundIndex = participants.findIndex(p => p.ovog === winner.ovog && p.ner === winner.ner);
            if (foundIndex > -1) {
                participants.splice(foundIndex, 1);
            }
            
            updateList();

            const currentPrize = prizesConfig[currentPrizeIndex];
            const overlay = document.getElementById('finalResultOverlay');
            const finalText = document.getElementById('finalWinnerText');
            
            overlay.classList.remove('hidden');
            finalText.innerText = `${winner.ovog} ${winner.ner}`;

            addWinnerToTable(winner, currentPrize.name);
            fireConfetti();

            currentPrize.current++; 
            winnersCount++;
            if (currentPrize.current >= currentPrize.total) {
                currentPrizeIndex++;
            }

            isSpinning = false;
            
            setTimeout(() => {
                const btn = document.getElementById('startBtn');
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
                btn.innerText = "–≠—Ö–ª“Ø“Ø–ª—ç—Ö";
                updatePrizeUI();
            }, 2000);
        }

        // --- LIST & TABLE FUNCTIONS ---
        function addWinnerToTable(person, prizeName) {
            const tbody = document.getElementById('winnersTableBody');
            const emptyState = document.getElementById('emptyState');
            if (emptyState) emptyState.style.display = 'none';

            const tr = document.createElement('tr');
            tr.className = "winner-anim hover:bg-gray-50 border-b";
            tr.innerHTML = `
                <td class="px-4 py-3 font-bold text-gray-500">${winnersCount + 1}</td>
                <td class="px-4 py-3 text-indigo-600 font-semibold text-xs">${prizeName}</td>
                <td class="px-4 py-3 font-bold text-gray-800">${person.ovog} ${person.ner}</td>
            `;
            tbody.insertBefore(tr, tbody.firstChild);
        }

        function updatePrizeUI() {
            const prize = prizesConfig[currentPrizeIndex];
            const btn = document.getElementById('startBtn');
            const img = document.getElementById('prizeImage');
            const name = document.getElementById('prizeName');
            const counter = document.getElementById('prizeCounter');
            const tag = document.getElementById('prizeTag');

            if (!prize) {
                name.innerText = "üéâ –ë“Æ–• –ê–ó–¢–ê–ù –¢–û–î–û–†–õ–û–û!";
                counter.innerText = "";
                img.src = "https://cdn-icons-png.flaticon.com/512/864/864837.png";
                tag.style.display = 'none';
                btn.innerText = "–ë–∞—è—Ä —Ö“Ø—Ä–≥—ç–µ!";
                btn.disabled = true;
                btn.className = "w-full bg-gray-400 text-white font-bold py-4 rounded-xl shadow-none cursor-not-allowed";
                return;
            }

            name.innerText = prize.name;
            counter.innerText = `–ê–∑—Ç–∞–Ω: ${prize.current + 1} / ${prize.total}`;
            img.src = prize.img;
            
            if (currentPrizeIndex === prizesConfig.length - 1) {
                tag.innerText = "‚≠ê –°—É–ø–µ—Ä –®–∞–≥–Ω–∞–ª ‚≠ê";
                tag.className = "bg-yellow-400 text-yellow-900 text-sm font-bold px-4 py-1 rounded-full uppercase animate-bounce inline-block mb-2";
            } else {
                tag.innerText = "–≠—ç–ª–∂–∏—Ç —à–∞–≥–Ω–∞–ª";
                tag.className = "bg-indigo-100 text-indigo-800 text-xs font-bold px-3 py-1 rounded-full uppercase inline-block mb-2";
            }
        }

        function addParticipant() {
            const ln = document.getElementById('lastName').value.trim();
            const fn = document.getElementById('firstName').value.trim();
            if (ln && fn) {
                participants.push({ ovog: ln, ner: fn });
                document.getElementById('lastName').value = '';
                document.getElementById('firstName').value = '';
                updateList();
            }
        }

        function updateList() {
            const listEl = document.getElementById('participantList');
            document.getElementById('count').innerText = participants.length;
            listEl.innerHTML = '';
            const displayLimit = participants.length > 100 ? 100 : participants.length;
            for(let i=0; i<displayLimit; i++) {
                const p = participants[i];
                const li = document.createElement('li');
                li.className = "p-2 text-xs flex justify-between hover:bg-gray-50";
                li.innerHTML = `<span>${i+1}. ${p.ovog} ${p.ner}</span>`;
                listEl.appendChild(li);
            }
            if (participants.length > 100) {
                const li = document.createElement('li');
                li.className = "p-2 text-xs text-center text-gray-400 italic";
                li.innerText = `... —Ü–∞–∞–Ω–∞ –Ω—å ${participants.length - 100} —Ö“Ø–Ω –±–∞–π–Ω–∞ ...`;
                listEl.appendChild(li);
            }
        }

        function clearList() { if(confirm("–¶—ç–≤—ç—Ä–ª—ç—Ö “Ø“Ø?")) { participants = []; updateList(); }}

        function fireConfetti() {
            var duration = 3000; var end = Date.now() + duration;
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }
    </script>
</body>
</html>
